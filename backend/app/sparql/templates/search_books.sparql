{# SPARQL template for searching books/literary works #}
{# Optimized for Wikidata Query Service performance #}

SELECT ?book ?bookLabel ?author ?authorLabel ?pubDate (GROUP_CONCAT(DISTINCT ?genreLabel; separator=", ") AS ?genres) (GROUP_CONCAT(DISTINCT ?awardLabel; separator=", ") AS ?awards)
WHERE {
  {
    SELECT DISTINCT ?book ?pubDate 
    WHERE {
      VALUES ?type { wd:Q7725634 wd:Q571 wd:Q47461344 }
      ?book wdt:P31 ?type.
      ?book wdt:P577 ?pubDate.
      
      {# === FILTERS === #}
      
      {% if genre_qid %}
      ?book wdt:P136 wd:{{ genre_qid }}.
      {% endif %}
      
      {% if year_start and year_end %}
      FILTER(YEAR(?pubDate) >= {{ year_start }} && YEAR(?pubDate) <= {{ year_end }})
      {% elif year_start %}
      FILTER(YEAR(?pubDate) >= {{ year_start }})
      {% elif year_end %}
      FILTER(YEAR(?pubDate) <= {{ year_end }})
      {% endif %}

      {# Nationality filter requires author join, optimize later if slow #}
      {% if country_qid %}
      ?book wdt:P50 ?author_filter.
      ?author_filter wdt:P27 wd:{{ country_qid }}.
      {% endif %}

      {% if location_qid %}
      ?book wdt:P50 ?author_filter.
      ?author_filter wdt:P19 wd:{{ location_qid }}.
      {% endif %}
    }
    ORDER BY DESC(?pubDate)
    LIMIT {{ limit | default(50) }}
    OFFSET {{ offset | default(0) }}
  }

  ?book wdt:P50 ?author.
  
  OPTIONAL { ?book wdt:P136 ?genre. ?genre rdfs:label ?genreLabel. FILTER(LANG(?genreLabel) = "en") }
  OPTIONAL { ?book wdt:P166 ?award. ?award rdfs:label ?awardLabel. FILTER(LANG(?awardLabel) = "en") }
  
  SERVICE wikibase:label { bd:serviceParam wikibase:language "en,auto,it,fr,de,es". }
}
GROUP BY ?book ?bookLabel ?author ?authorLabel ?pubDate
ORDER BY DESC(?pubDate)
